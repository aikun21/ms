# Vue3 消息应用

基于 Vue3 + Vite + Pinia + TypeScript 构建的高性能消息应用，支持长消息列表虚拟滚动、消息发送、撤回删除、草稿保存、新消息提示等完整功能。

## 技术栈

- **Vue 3** - 渐进式 JavaScript 框架
- **Vite** - 下一代前端构建工具
- **Pinia** - Vue 的状态管理库
- **TypeScript** - 类型安全的 JavaScript 超集
- **Axios** - HTTP 客户端
- **vue-virtual-scroller** - 虚拟滚动组件，用于优化长列表性能

## 项目结构

```
src/
├── components/          # 组件目录
│   ├── MessageList.vue      # 消息列表组件（使用虚拟滚动）
│   ├── MessageItem.vue       # 消息项组件
│   ├── MessageInput.vue      # 消息输入框组件
│   ├── MessageSearch.vue     # 消息搜索组件
│   ├── NetworkStatus.vue     # 网络状态组件
│   ├── DateHeader.vue        # 日期标题组件
│   └── UnreadIndicator.vue   # 未读消息提示组件
├── pages/              # 页面目录
│   └── MessagePage.vue       # 消息页面主组件
├── services/           # 服务目录（API接口）
│   └── messageService.ts     # 消息服务（模拟接口）
├── store/              # 状态管理目录
│   ├── messageStore.ts       # 消息状态管理（Pinia）
│   └── networkStore.ts       # 网络状态管理（Pinia）
├── types/              # 类型定义目录
│   └── message.ts            # 消息相关类型定义
├── utils/              # 工具函数目录
│   └── request.ts            # HTTP请求封装模块
├── config/             # 配置目录
│   └── index.ts              # 应用配置（包括初始化消息条数）
├── App.vue             # 根组件
├── main.ts             # 应用入口文件
└── style.css           # 全局样式
```

### 目录说明

- **components/** - 存放可复用的 Vue 组件

  - `MessageList.vue`: 消息列表容器组件，使用虚拟滚动优化性能，支持历史消息分页加载
  - `MessageItem.vue`: 单个消息项组件，显示消息内容、状态和操作按钮（撤回、删除）
  - `MessageInput.vue`: 消息输入框组件，处理消息发送和草稿保存
  - `MessageSearch.vue`: 消息搜索组件，支持关键字搜索和发送人过滤
  - `NetworkStatus.vue`: 网络状态组件，显示网络连接状态和离线消息数量
  - `DateHeader.vue`: 日期标题组件，显示消息日期分组（今天、昨天等）
  - `UnreadIndicator.vue`: 未读消息提示组件，显示未读消息数量并支持一键跳转

- **pages/** - 存放页面级组件

  - `MessagePage.vue`: 消息页面主组件，整合所有功能模块

- **services/** - 存放业务逻辑和 API 调用

  - `messageService.ts`: 消息相关的服务函数，包含模拟接口（发送、加载历史、撤回、删除）

- **store/** - 存放 Pinia 状态管理

  - `messageStore.ts`: 消息状态管理，统一管理消息列表、搜索过滤、撤回删除等操作
  - `networkStore.ts`: 网络状态管理，监控网络连接状态和自动重连

- **types/** - 存放 TypeScript 类型定义

  - `message.ts`: 消息相关的类型和枚举（消息状态、消息类型等）

- **utils/** - 存放工具函数

  - `request.ts`: HTTP 请求封装模块，统一处理请求和响应

- **config/** - 存放应用配置
  - `index.ts`: 应用配置项，包括初始化消息条数、分页大小、API 配置等

## 功能特性

### 1. 请求封装与模拟接口

- 统一的 HTTP 请求封装（`src/utils/request.ts`）
- 配置了基础 URL、超时时间和错误处理
- 模拟接口函数，随机返回成功或失败（延迟 0.5-2 秒）
- 模拟数据不会生成未来的时间戳

### 2. 长消息列表性能优化

- 初始化时生成并渲染 50+ 条历史消息（可配置）
- 使用 `vue-virtual-scroller` 实现虚拟滚动
- 保证滚动流畅，接近 60FPS 的自然体验
- **历史消息分页加载**：滚动到顶部时自动加载更早的消息
- **滚动位置保持**：加载历史消息后自动保持当前滚动位置

### 3. 消息发送功能

- 输入框发送文本消息（支持 Enter 发送）
- 实时显示"发送中"、"发送成功"、"发送失败"状态
- 发送失败时提供重试按钮
- **草稿保存**：自动保存输入框内容，刷新页面或切换会话后可恢复
- **离线消息处理**：网络断开时消息自动保存到待发送队列，网络恢复后自动重发

### 4. 消息管理功能

- **消息撤回**：发送成功后的消息可在 2 分钟内撤回
- **消息删除**：支持删除已发送的消息
- 撤回或删除后的消息不再显示"发送成功"状态
- 撤回和删除按钮仅在鼠标悬停时显示

### 5. 消息搜索与过滤

- **关键字搜索**：支持搜索消息内容，高亮显示匹配的关键字
- **发送人过滤**：支持按发送人筛选消息
- 显示搜索结果数量
- 一键清除搜索和过滤条件

### 6. 日期分组显示

- 自动按日期分组显示消息（今天、昨天、具体日期）
- **粘性日期标题**：滚动时日期标题固定在顶部
- 消息按时间顺序从早到晚排列

### 7. 新消息提示

- **未读消息提示**：用户向上滚动浏览历史记录时，有新消息推送会在底部显示未读提示
- 显示未读消息数量
- **一键跳转**：点击未读提示可快速跳转到底部查看新消息
- 自动检测用户是否在底部，在底部时不显示提示

### 8. 网络状态监控

- 实时监控网络连接状态
- 显示网络状态（在线/离线/重连中）
- 离线时显示待发送消息数量
- 网络恢复后自动重发待发送的消息
- 支持模拟断网和恢复（开发测试用）

### 9. 组件拆分与状态管理

- 消息列表、消息项、输入框、搜索等拆分为独立组件
- 使用 Pinia 统一管理消息状态和网络状态
- 组件间通过状态管理进行通信，避免过度传参

## 配置说明

### 修改初始化消息条数

在 `src/config/index.ts` 文件中修改 `INITIAL_MESSAGE_COUNT` 常量：

```typescript
export const INITIAL_MESSAGE_COUNT = 500; // 修改为你想要的数字
```

### 修改分页大小

在 `src/config/index.ts` 文件中修改 `PAGE_SIZE` 常量：

```typescript
export const PAGE_SIZE = 50; // 修改为你想要的每页加载条数
```

### 修改 API 配置

在 `src/config/index.ts` 文件中修改 `API_CONFIG`：

```typescript
export const API_CONFIG = {
  BASE_URL: "/api", // 修改基础URL
  TIMEOUT: 10000, // 修改超时时间（毫秒）
};
```

### 修改撤回时间限制

在 `src/config/index.ts` 文件中修改 `REVOKE_TIME_LIMIT` 常量：

```typescript
export const REVOKE_TIME_LIMIT = 2 * 60 * 1000; // 撤回时间限制（2分钟，毫秒）
```

## 安装与运行

### 前置要求

- Node.js >= 16.0.0
- npm >= 7.0.0 或 yarn >= 1.22.0

### 安装依赖

```bash
npm install
```

**注意**: 安装依赖后，TypeScript 类型检查错误会自动消失。

### 开发模式

```bash
npm run dev
```

启动后，在浏览器中打开显示的本地地址（通常是 `http://localhost:5173`）

### 构建生产版本

```bash
npm run build
```

构建产物将输出到 `dist` 目录

### 预览生产版本

```bash
npm run preview
```

## 性能优化说明

1. **虚拟滚动**: 使用 `vue-virtual-scroller` 组件，只渲染可见区域的消息项，大幅提升长列表性能
2. **分页加载**: 当用户滚动到列表顶部时，自动异步加载更早的历史消息，避免一次性加载过多数据
3. **状态管理**: 使用 Pinia 进行状态管理，避免不必要的组件重新渲染
4. **组件拆分**: 合理拆分组件，提高代码复用性和维护性
5. **滚动位置保持**: 加载历史消息后自动保持当前滚动位置，提供流畅的用户体验
6. **防抖优化**: 草稿保存使用防抖机制，避免频繁写入 localStorage

## 使用说明

### 发送消息

- 在输入框中输入消息内容
- 按 `Enter` 键或点击"发送"按钮发送消息
- 消息会自动保存草稿，刷新页面后可恢复

### 撤回消息

- 鼠标悬停在消息上，点击"撤回"按钮
- 仅支持撤回 2 分钟内发送成功的消息
- 撤回后的消息显示"此消息已撤回"

### 删除消息

- 鼠标悬停在消息上，点击"删除"按钮
- 确认后消息将被删除
- 删除后的消息显示"此消息已删除"

### 搜索消息

- 在搜索框中输入关键字，实时搜索消息内容
- 匹配的关键字会高亮显示
- 可选择发送人进行过滤
- 点击"清除"按钮清除搜索和过滤条件

### 查看新消息

- 当有新消息推送时，如果不在底部，会显示未读提示
- 点击未读提示可快速跳转到底部查看新消息
- 滚动到底部后，未读提示自动消失

## 注意事项

- 当前使用的是模拟接口，实际项目中需要替换为真实 API
- 虚拟滚动组件需要设置固定高度才能正常工作
- 消息 ID 使用时间戳和随机数生成，确保唯一性
- 草稿保存在 localStorage 中，清除浏览器数据会丢失草稿
- 撤回时间限制为 2 分钟，可在配置文件中修改 `REVOKE_TIME_LIMIT`
